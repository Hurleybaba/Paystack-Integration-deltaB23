# Paystack Subscription & Payment Management App

A comprehensive Node.js + Express application that integrates with **Paystack** for managing **plans**, **subscriptions**, **transactions**, **installments**, and **webhooks**. The application includes automated cron jobs for subscription expiry monitoring and installment payment tracking, along with email notifications and a complete HTML front-end for testing and demonstration.

---

## ğŸš€ Features

### Core Features

- âœ… **Paystack Plans Management** - Create, list, fetch, and update subscription plans
- âœ… **Subscription Management** - Create, list, and disable subscriptions
- âœ… **Payment Processing** - Initialize and verify transactions
- âœ… **Transaction Listing** - View all transactions with pagination
- âœ… **Webhook Handling** - Secure webhook processing with signature validation
- âœ… **Installment Payment System** - Create and manage installment payment plans with auto-charging
- âœ… **Automated Cron Jobs** - Monitor subscription expiry and installment due dates
- âœ… **Email Notifications** - Send subscription expiry reminders via email
- âœ… **PostgreSQL Database** - Store users, subscriptions, and installments
- âœ… **HTML Front-end** - Complete demo pages for testing all features

---

## ğŸ“‚ Project Structure

```
project/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ db.js                    # PostgreSQL database connection
â”‚   â””â”€â”€ paystackConfig.js        # Axios config for Paystack API calls
â”‚
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ installmentController.js # Handles installment creation, payments, and auto-charging
â”‚   â”œâ”€â”€ paymentController.js     # Handles transaction initialization and verification
â”‚   â”œâ”€â”€ planController.js        # Handles plan CRUD operations
â”‚   â”œâ”€â”€ subscriptionController.js # Handles subscription creation, listing, and disabling
â”‚   â””â”€â”€ webhookController.js     # Handles Paystack webhook events
â”‚
â”œâ”€â”€ middlewares/
â”‚   â”œâ”€â”€ errorHandler.js          # Global error handler middleware
â”‚   â””â”€â”€ validateSignature.js     # Paystack webhook signature validator
â”‚
â”œâ”€â”€ public/                       # Static HTML pages for demonstration
â”‚   â”œâ”€â”€ index.html               # Main dashboard
â”‚   â”œâ”€â”€ create-plan.html         # Create subscription plans
â”‚   â”œâ”€â”€ list-plans.html          # View all plans
â”‚   â”œâ”€â”€ create-subscription.html # Create subscriptions
â”‚   â”œâ”€â”€ list-subscriptions.html  # View all subscriptions
â”‚   â”œâ”€â”€ delete-subscription.html # Disable subscriptions
â”‚   â”œâ”€â”€ list-transactions.html   # View transactions
â”‚   â”œâ”€â”€ test-payment.html        # Initialize payments
â”‚   â”œâ”€â”€ verify-payment.html      # Verify payment status
â”‚   â”œâ”€â”€ installmental-form.html  # Create installment plans
â”‚   â”œâ”€â”€ view-installments.html   # View active installments
â”‚   â”œâ”€â”€ installment-dashboard.html # Installment management dashboard
â”‚   â”œâ”€â”€ signin.html              # User sign in page
â”‚   â”œâ”€â”€ signup.html              # User sign up page
â”‚   â”œâ”€â”€ success.html             # Payment success page
â”‚   â”œâ”€â”€ failed.html              # Payment failure page
â”‚   â””â”€â”€ webhook-test.html        # Webhook testing page
â”‚
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ installmentRoutes.js     # Installment API routes
â”‚   â”œâ”€â”€ paymentRoutes.js         # Payment API routes
â”‚   â”œâ”€â”€ planRoutes.js            # Plan API routes
â”‚   â”œâ”€â”€ subscriptionRoutes.js     # Subscription API routes
â”‚   â””â”€â”€ webhookRoutes.js         # Webhook endpoint
â”‚
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ cronJobTest.js           # Subscription expiry checker cron job
â”‚   â”œâ”€â”€ dbUtils.js               # Database utility functions
â”‚   â”œâ”€â”€ emailService.js          # Email sending service (Nodemailer)
â”‚   â”œâ”€â”€ installmentCronJob.js    # Installment monitoring cron job
â”‚   â””â”€â”€ subscriptionReminder.js  # Subscription reminder utilities
â”‚
â”œâ”€â”€ .env                         # Environment variables
â”œâ”€â”€ .gitignore                   # Git ignore file
â”œâ”€â”€ app.js                       # Express server setup and configuration
â”œâ”€â”€ package.json                 # Project dependencies and scripts
â”œâ”€â”€ schema.sql                   # PostgreSQL database schema
â”œâ”€â”€ TODOS.txt                    # Development tasks
â””â”€â”€ README.md                    # This file
```

---

## âš™ï¸ Setup Instructions

### 1. Prerequisites

- Node.js (v14 or higher)
- PostgreSQL database
- Paystack account (test or live keys)
- Gmail account (for email notifications - optional)

### 2. Clone and Install

```bash
git clone <repo-url>
cd <repo-folder>
npm install
```

### 3. Database Setup

1. Create a PostgreSQL database
2. Run the schema file to create tables:

```bash
psql -U your_username -d your_database -f schema.sql
```

Or manually execute the SQL commands in `schema.sql` to create:

- `users` table
- `subscriptions` table
- `installments` table
- `installment_payments` table

### 4. Environment Variables

Create a `.env` file in the root directory:

```env
# Server Configuration
PORT=5001

# Paystack Configuration
PAYSTACK_SECRET_KEY=sk_test_your_secret_key
PAYSTACK_PUBLIC_KEY=pk_test_your_public_key
PAYSTACK_BASE_URL=https://api.paystack.co

# PostgreSQL Database Configuration
PGHOST=localhost
PGUSER=your_username
PGPASSWORD=your_password
PGDATABASE=your_database
PGPORT=5432

# Email Configuration (for notifications)
EMAIL_USER=your_email@gmail.com
EMAIL_PASS=your_app_password
```

**Note:** For Gmail, you'll need to generate an [App Password](https://support.google.com/accounts/answer/185833) if 2FA is enabled.

### 5. Run the Server

**Production mode:**

```bash
npm run node
```

**Development mode (with auto-reload):**

```bash
npm run dev
```

The server will start on `http://localhost:5001` (or your configured PORT).

### 6. Access the Dashboard

Open your browser and navigate to:

```
http://localhost:5001
```

---

## ğŸ“¡ API Endpoints

### Payment Endpoints

| Method | Endpoint                          | Description                             |
| ------ | --------------------------------- | --------------------------------------- |
| `POST` | `/api/payments/initialize`        | Initialize a payment transaction        |
| `GET`  | `/api/payments/verify/:reference` | Verify a payment transaction            |
| `GET`  | `/api/payments/list`              | List all transactions (with pagination) |

**Example: Initialize Payment**

```bash
POST /api/payments/initialize
Content-Type: application/json

{
  "email": "customer@example.com",
  "amount": 5000
}
```

### Plan Endpoints

| Method | Endpoint                 | Description                    |
| ------ | ------------------------ | ------------------------------ |
| `POST` | `/api/plans/create`      | Create a new subscription plan |
| `GET`  | `/api/plans/list`        | List all plans (with filters)  |
| `GET`  | `/api/plans/:id_or_code` | Get plan details by ID or code |
| `PUT`  | `/api/plans/:id_or_code` | Update a plan                  |

**Example: Create Plan**

```bash
POST /api/plans/create
Content-Type: application/json

{
  "name": "Monthly Premium",
  "amount": 10000,
  "interval": "monthly",
  "description": "Premium monthly subscription"
}
```

### Subscription Endpoints

| Method | Endpoint                       | Description                   |
| ------ | ------------------------------ | ----------------------------- |
| `POST` | `/api/subscriptions/subscribe` | Create a new subscription     |
| `GET`  | `/api/subscriptions/list`      | List all subscriptions        |
| `POST` | `/api/subscriptions/disable`   | Disable/cancel a subscription |

**Example: Create Subscription**

```bash
POST /api/subscriptions/subscribe
Content-Type: application/json

{
  "email": "customer@example.com",
  "plan": "PLN_xxxxx",
  "authorization": "AUTH_xxxxx"
}
```

### Installment Endpoints

| Method | Endpoint                         | Description                                   |
| ------ | -------------------------------- | --------------------------------------------- |
| `POST` | `/api/installments`              | Create a new installment plan                 |
| `GET`  | `/api/installments/active`       | Get all active installments (filter by email) |
| `GET`  | `/api/installments/:id`          | Get installment details                       |
| `GET`  | `/api/installments/:id/payments` | Get payment history for an installment        |
| `POST` | `/api/installments/auto-pay`     | Auto-charge an installment (cron job)         |
| `POST` | `/api/installments/manual-pay`   | Process manual installment payment            |

**Example: Create Installment**

```bash
POST /api/installments
Content-Type: application/json

{
  "email": "customer@example.com",
  "totalAmount": 100000,
  "monthlyPayment": 10000
}
```

### Webhook Endpoint

| Method | Endpoint        | Description               |
| ------ | --------------- | ------------------------- |
| `POST` | `/api/webhooks` | Paystack webhook endpoint |

**Note:** This endpoint requires raw body parsing for signature validation.

---

## ğŸ” Paystack Webhook Setup

### 1. Configure Webhook URL

Go to [Paystack Dashboard](https://dashboard.paystack.com) â†’ Settings â†’ API â†’ Webhooks

Set your webhook URL:

- **Production:** `https://yourdomain.com/api/webhooks`
- **Development (ngrok):** `https://<your-ngrok-id>.ngrok.io/api/webhooks`

### 2. Webhook Events Handled

The application handles the following Paystack webhook events:

- `subscription.create` - Creates subscription record in database
- `charge.success` - Updates user authorization and customer codes
- `invoice.payment_failed` - Logs failed payment attempts
- `subscription.not_renew` - Marks subscription as inactive
- `subscription.enable` - Marks subscription as active

### 3. Signature Validation

The webhook endpoint automatically validates Paystack signatures using HMAC SHA512 to ensure requests are authentic.

---

## ğŸ¤– Automated Cron Jobs

### 1. Subscription Expiry Checker

**File:** `utils/cronJobTest.js`

- **Schedule:** Runs every 1 minute
- **Function:** Checks for subscriptions expiring within the next 10 minutes
- **Action:** Sends email reminders to users
- **Status:** Currently commented out in `app.js` (line 55)

To enable:

```javascript
subscriptionExpiryCheckerCron();
```

### 2. Installment Monitor

**File:** `utils/installmentCronJob.js`

- **Schedule:** Runs every 5 minutes
- **Function:**
  - Checks for fully paid installments and marks them as completed
  - Updates next payment dates for active installments
  - Logs payment reminders
- **Status:** Active by default

---

## ğŸ’¾ Database Schema

### Users Table

Stores user information and Paystack authorization codes.

### Subscriptions Table

Tracks subscription status, plan codes, and next payment dates.

### Installments Table

Manages installment payment plans with:

- Total amount and monthly payment
- Amount paid and remaining balance
- Next payment date
- Status (active, completed, overdue)

### Installment Payments Table

Records all installment payment transactions.

See `schema.sql` for complete table definitions and triggers.

---

## ğŸ“§ Email Notifications

The application uses Nodemailer to send email notifications for:

- Subscription expiry reminders (10 minutes before expiry)

**Configuration:**

- Service: Gmail (configurable)
- Requires: `EMAIL_USER` and `EMAIL_PASS` in `.env`

---

## ğŸ§ª Testing

### Using HTML Pages

Navigate to `http://localhost:5001` to access the dashboard with links to:

- Create and manage plans
- Create and manage subscriptions
- Initialize and verify payments
- Create and view installments
- Test webhooks

### Using API Clients

Use tools like Postman, cURL, or Thunder Client to test API endpoints directly.

**Example cURL:**

```bash
curl -X POST http://localhost:5001/api/payments/initialize \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "amount": 5000}'
```

---

## ğŸ› ï¸ Technologies Used

- **Runtime:** Node.js
- **Framework:** Express.js
- **Database:** PostgreSQL
- **Payment Gateway:** Paystack API
- **Email Service:** Nodemailer
- **Task Scheduling:** node-cron
- **HTTP Client:** Axios
- **Environment Variables:** dotenv

---

## ğŸ“ Development Notes

- The application uses ES6 modules (`import/export`)
- Raw body parsing is configured for webhook signature validation
- All amounts are converted to kobo (multiply by 100) for Paystack API
- Installment payment dates handle month-end edge cases automatically

---

## ğŸ”’ Security Considerations

1. **Never commit `.env` file** - Contains sensitive keys
2. **Validate webhook signatures** - Prevents unauthorized requests
3. **Use HTTPS in production** - Required for webhook endpoints
4. **Sanitize user inputs** - Prevent SQL injection
5. **Use environment-specific keys** - Separate test and live keys

---

## ğŸ“„ License

ISC

---

## ğŸ‘¥ Contributors

Built by **Delta Team** â€” Paystack Integration Test

---

## ğŸ› Troubleshooting

### Webhook not receiving events

- Verify webhook URL is accessible (use ngrok for local testing)
- Check Paystack dashboard for webhook delivery logs
- Ensure signature validation is working correctly

### Database connection errors

- Verify PostgreSQL is running
- Check database credentials in `.env`
- Ensure database and tables exist

### Email not sending

- Verify Gmail App Password is correct
- Check `EMAIL_USER` and `EMAIL_PASS` in `.env`
- Ensure 2FA is enabled and App Password is generated

### Installment cron not running

- Check server logs for cron job initialization
- Verify cron schedule syntax
- Ensure database connection is active

---

## ğŸ“š Additional Resources

- [Paystack API Documentation](https://paystack.com/docs/api)
- [Paystack Webhooks Guide](https://paystack.com/docs/payments/webhooks)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [Express.js Documentation](https://expressjs.com/)
